## TCP相关整理



TCP是一种面向连接的，基于字节流的，可靠的传输控制协议。

属于OSI七层模型中的传输层。

### 内容梳理

![1568734229571](/home/chen/.config/Typora/typora-user-images/1568734229571.png)

- hhhh,暂时梳理随时改

### 一、TCP报文首部

![](/home/chen/Desktop/9rzlJf.png)



TCP首部大小在20~60字节，其中标准长度为20个字节。

**源端口和目的端口**

TCP的四元组为源IP，源端口，目的IP，目的端口，**TCP首部中的源端口和目的端口结合IP首部中的源和目的IP地址组成了一个连接的四元组。**

**序号/序列号(SEQ)**

在一个TCP连接中唯一标识TCP报文段，是重传机制的重要字段。

自ISN（初始序列号）起，单调递增。

**确认号(ACK)**

接收端发送给发送端，是期望对方下一个报文段的第一个字节的序号。

**若ACK=n，则表示n之前的报文都已收到（不包括n）**

**数据偏移**

表示TCP数据部分相对于整个TCP报文段来说的偏移量，可以简单理解为TCP首部的长度。

**控制位**

1. URG - 紧急，置位后首部紧急指针生效
2. ACK - 确认，置位后确认号生效
3. PSH - 推送，置位后接收方应尽快给应用程序推送该段数据
4. RST - 重置，置位后表示该报文为重置报文，取消连接
5. SYN - 初始化，置位表示为初始化报文，用于初始化TCP连接
6. FIN - 结束，职位表示当前端结束数据传输工作

**URG之前还有CWR - 拥塞窗口 以及 ECE - ECN回显，在一些TCP的实现里面并没有这两位。**

**窗口**

**通常在ACK报文中附带，作为接收方对发送方的背压，是影响发送端发送速率的因素之一。**

占16位，单位为字节，所以在没有**窗口缩放**选项的情况下，最大为65535字节。

**校验和**

**报文段正确性校验使用，**占两位。

校验范围包括首部和数据部分，和UDP一样需要再生成12字节的伪首部参与计算。

伪首部包括源和目的IP，保证通信双方的正确性。

**紧急指针**

只有在**URG控制位**置位的情况下生效。

表示紧急报文在**报文段序列号字段**上的正偏移，序列号超过紧急指针的即为正常数据。

零窗口的情况下也可以发送紧急报文。

**选项**

**1. MSS - 最大报文段长度**

连接中每个TCP报文段的**数据字段**的最大长度，不包含首部。

在SYN报文中协商，双方都可以指定自己的MSS，甚至可以不同，默认为536字节。

**2. SACK - 选择确认**

当接收方接受到乱序数据时，就会在接收窗口产生缺口。

设置SACK选项就是为了描述这些缺口信息，使发送方更好，更准确的重传这些缺口数据。

**3. WSCALE/WSOPT - 窗口缩放**

由于首部的**窗口大小**字段仅占16位，所以影响的范围也仅在0~2^16(65535)之间。

该选项就是为了增加窗口大小字段的范围，从16位提升至30位。

该选项只能出现在一个SYN报文段中，而SYN报文仅仅在初始化时通信双方各发一次，由此可知：

**连接建立之后窗口缩放的比例因子是与方向绑定的**，通信双方的比例因子可以不同。

**4. TSOPT - 时间戳选项** 

该选项要求发送方在每一个报文中添加2个4字节的单调递增的时间戳数值。

分别是：**TSval/TSV 发送时间戳 以及 TSecr/TSER 时间戳回显**。

该选项的设置可以很好的解决重传的二义性，也能更加精确的计算RTT。

**5. 其他**

另外的还有**认证选项**以及**用户超时选项**等等。



### 二、连接管理



#### 建立连接

稍微有点尝试的程序猿应该都知道，TCP建立连接的时候需要往返发送三个报文。

   ![1568818645296](/home/chen/.config/Typora/typora-user-images/1568818645296.png)

1. 连接发起者(客户端)会向服务端发送一个**SYN报文**，报文中除了目的端口，还包括ISN(初始序列号)以及部分选项字段。
2. 服务端接受后会回复一个**SYN报文**作为响应，然后将接收到的SEQ+1，作为报文的ACK值，并指明服务端的的初始序列号等信息。
3. 客户端响应一个ACK报文，同样的将服务端SYN报文中的SEQ+1作为ACK值。

##### 为什么要三次握手

首先明确，**三次握手的主要目的是交换双方的ISN以及选项。**

这些字段，例如是否启用SACK等都将是数据传输时的重要属性。

交换双方的信息至少需要两次握手，而第三次握手则是为了**防止已失效的连接请求又被转发到了服务端**。

意思就是如果客户端在收到服务端的SYN+ACK报文时就建立一个连接，那么在上述情况下将会出现先后多条连接的情况。

四元组一样无法建立相同连接，但是可以先后。

我感觉可能防止建立重复连接的功能可能是意外之喜。

另外**可以发现SYN报文也占用了一个序列号。**



#### 初始序列号 - ISN

在发送用于建立连接的SYN报文时，通信的双方都会选择一个初始化序列号。

每个连接都会有不同的初始化序列号。

目前，我还不清楚SYN报文的重传会不会导致SEQ的变化，如果并不会的话，那重传的SYN报文在服务端就可以拦截下来。

《TCP/IP详解》的原文在13.2章节:**此外，为了确认客户端的SYN，服务器将其包含的ISN(c)数值加1后作为返回的ACK数值。因此，每发送一个SYN，序列号都会自动加1。这样如果出现丢失的情况，该SYN段将会重传**



#### 关闭连接

相对来说关闭连接的四次挥手就好理解多了。

   ![1568820312811](/home/chen/.config/Typora/typora-user-images/1568820312811.png)

1. 连接的主动关闭方，发送一个FIN报文。
2. 被动方回复一个ACK。
3. 被动方主动发送一个FIN报文。
4. 主动方回复一个ACK

##### 为什么要四次挥手

相比于三次握手来说，可以看作是被动关闭方的FIN报文和ACK报文拆开了，而三次握手的SYN报文和ACK报文是一起发出的。

至于为什么要拆开，我的理解是因为半关闭状态的存在，作为一个全双工的协议，连接的双方都可以互相发送数据。

某一端发送了FIN报文就表示己方的数据发送完毕，而等待对象的FIN。

主动关闭方发送了FIN报文之后就停止向对端发送数据，而是只做承接并响应ACK报文。

因此就分别需要两个FIN报文和两个ACK报文才足以完整的关闭一条(全双工)连接。



#### 半关闭状态

半关闭状态是指TCP连接双方，有一端发送了FIN报文，而另一端还在继续传输数据，此时的主动关闭方仍然会对接收的数据作ACK报文的响应。 

